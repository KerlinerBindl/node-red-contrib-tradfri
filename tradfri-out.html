<script type="text/javascript">
    RED.nodes.registerType('tradfri-get', {
        category: 'function',
        defaults: {
            name: {value: ""},
            hub : {type: "tradfri-config", required: true}
        },
        color: "#E9967A",
        icon: "light.png",
        align: 'left',
        inputs: 1,
        outputs: 1,
        label : function(){ return this.name || "tradfri get"}
    });
</script>
<script type="text/x-red" data-template-name="tradfri-get">
    <div class="form-row" style="display:none">
        <input type="text" id="node-input-name"><input type="text" id="node-input-dtype">
    </div>
    <div class="form-row">
        <label for="node-input-config"><i class="fa fa-bookmark"></i> Config</label>
        <input type="text" id="node-input-hub">
    </div>
    <div class="form-row">
        <i style="font-size:95%;color:#E9967A"><span id="tradfri-help"></span></i>
    </div>
</script>
<script type="text/x-red" data-help-name="tradfri-get">
    <p>Retrieves IKEA TRÃ…DFRI device information from your IKEA hub.</p>
    <h3>Inputs</h3>
      <dl class="message-properties">
          <dt>payload
              <span class="property-type">string | integer | optional</span>
          </dt>
          <dd> the device or group id to lookup</dd>
      </dl>
    <h3>Outputs</h3>
         <ol class="node-ports">
             <li>Standard output
                 <dl class="message-properties">
                     <dt>payload <span class="property-type">object | array</span></dt>
                     <dd>Device, group object or an array with all groups and devices</dd>
                 </dl>
             </li>
         </ol>
    <h3>Details</h3>
    <p>If <code>msg.payload</code> is a number the details of that device or group will be retrieved and returned in msg.payload as an object. If <code>msg.payload</code> is not set or is not a number the complete structure will be retrieved from the defined IKEA Hub.</p>
    <p>The <code>Config</code> setting requests a number of parameters:
    <ul>
    <li><code>Security Code</code> - As found on the IKEA hub. See picture below</li>
    <li><code>IP address</code> - The IP address of the IKEA hub.</li>
    <li><code>CoAP path</code> - The file system path to the CoAP library that talked to the IKEA hub.</li>
    </ul>
    Look at <a href="https://github.com/nidayand/node-tradfri-argon" target=_blank>node-tradfri-argon</a> on instructions on how to compile the libcoap library. The executible will be in the [examples] directory when it has finished the compilation. E.g. <code>/home/pi/libcoap/examples/coap-client</code>
  </p>
</script>


<script type="text/javascript">
    RED.nodes.registerType('tradfri-out', {
        category: 'output',
        defaults: {
            name: {value: ""},
            dtype: {value: "device"},
            id: {value: "0", required:true},
            hub : {type: "tradfri-config", required: true}
        },
        color: "#E9967A",
        icon: "light.png",
        align: 'right',
        inputs: 1,
        outputs: 0,
        label : function(){ return this.name || "tradfri"},
        oneditsave: function(){
          $('#node-input-name').val($('#node-input-id option:selected').text());
          $('#node-input-dtype').val($('#node-input-id option:selected').attr('dtype'));
        },
        oneditprepare: function(){
          //Register help
          var setHover = function(obj, txt){
            obj.hover(function(){
              $('#tradfri-help').html(txt);
            },function(){
              $('#tradfri-help').html('');
            });
          }
          setHover($('#tradfri-custom-refresh'),'Click to refresh list of groups and devices from the IKEA hub');
          setHover($('#node-input-hub'),'Select IKEA hub configuration to use');
          setHover($('#node-input-id'),'Select the light to control or choose [By msg.id] to define the light to control via the inbound message');

          // Show name and id in select box
          if (parseInt(this.id) !== 0){
            $('#node-input-id').append($('<option>', {
                        value: this.id,
                        text : this.name,
                        dtype : this.dtype
                    }));
          }
          $('#node-input-id').val(this.id);

          // Register onchange to clear the list if config is changed
          $('#node-input-config').on('change',function(){
            $('#node-input-id').find('option').remove();
            $('#node-input-id').append('<option value="0">By msg.id</option>');
          });

          // Register onclick to get data
          $('#tradfri-custom-refresh').click(function(){

            // Get the selected configuration
            if ($('#node-input-hub option:selected').val() === "_ADD_"){
              alert("Please select a hub configuration");
              return;
            }

            //Start spinner
            $('#tradfri-spinner').addClass('fa-pulse');

            // Get the config node
            var c = RED.nodes.node($('#node-input-hub option:selected').val());

            // Try to connect to hub to get device and group data
            $.get('/tradfri/controls',{sid:c.sid, coap:c.coap, hubip:c.hubip}, function(data){

              // Stop spinner
              $('#tradfri-spinner').removeClass('fa-pulse');

              if (data.status === "ok"){
                //Store the currently selected id and name
                var id = $('#node-input-id option:selected').val();
                var name = $('#node-input-id option:selected').text();

                // Remove old options
                $('#node-input-id').find('option').remove();
                $('#node-input-id').append('<option value="0">By msg.id</option>');
                data.items.forEach(function(item){
                   $('#node-input-id').append($('<option>', {
                        value: item.id,
                        text : item.name + (item.type==='group'? ' (group)':''),
                        dtype: item.type
                    }));
                });
                $('#node-input-id').val(id);

                //Indicate update
                $("#node-input-id").fadeIn(100).fadeOut(100).fadeIn(100).fadeOut(100).fadeIn(100)

              } else {
                alert('Please verify your hub configuration settings or try again!');
              }
            });
          });
        }
    });
</script>
<script type="text/x-red" data-template-name="tradfri-out">
    <div class="form-row" style="display:none">
        <input type="text" id="node-input-name"><input type="text" id="node-input-dtype">
    </div>
    <div class="form-row">
        <label for="node-input-config"><i class="fa fa-bookmark"></i> Config</label>
        <input type="text" id="node-input-hub">
    </div>
    <div class="form-row">
        <label for="node-input-id"><i class="icon-tag"></i> Device</label>
        <select id="node-input-id" style="smargin-right:5px;">
            <option value="0">By msg.id</option>
        </select>

        <a id="tradfri-custom-refresh" class="editor-button" style=""><i id="tradfri-spinner" class="fa fa-refresh"></i></a>
    </div>
    <div class="form-row">
        <i style="font-size:95%;color:#E9967A"><span id="tradfri-help"></span></i>
    </div>
</script>
<script type="text/x-red" data-help-name="tradfri-out">
    <p></p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('tradfri-config', {
        category: 'config',
        defaults: {
            name:  {value: ""},
            hubip : {value: "", required:true},
            sid: {value:"", required:true},
            coap: {value:"", required:true}
        },
        label: function () {
            return this.name || "IKEA Hub";
        }
    });
</script>
<script type="text/x-red" data-template-name="tradfri-config">
    <div class="form-row" style="width:500px">
        <p></p>
    </div>
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-config-input-hubip"><i class="fa fa-tag"></i> Hub IP address</label>
        <input type="text" id="node-config-input-hubip" placeholder="Hub IP address">
    </div>
    <div class="form-row">
        <label for="node-config-input-sid"><i class="fa fa-tag"></i> Security Code</label>
        <input type="text" id="node-config-input-sid" placeholder="As found on IKEA hub device">
    </div>
    <div class="form-row">
        <label for="node-config-input-coap"><i class="fa fa-tag"></i> CoAP path</label>
        <input type="text" id="node-config-input-coap" placeholder="CoAP path">
    </div>
</script>
